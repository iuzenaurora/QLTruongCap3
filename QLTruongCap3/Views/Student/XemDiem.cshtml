@model QLTruongCap3.Models.sp_GetBangDiemTongHop_Result
@{
    Layout = "~/Views/Shared/_LayoutStudent.cshtml";
    ViewBag.Title = "Kết Quả Học Tập";

    // Lấy danh sách điểm chi tiết từ ViewBag
    // Sử dụng dynamic để linh hoạt nếu model chưa update kịp, hoặc list cụ thể nếu đã có class
    var listDiemChiTiet = ViewBag.ChiTietDiem as IEnumerable<dynamic>;
}

<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-success border-bottom pb-2">
            <i class="fas fa-graduation-cap me-2"></i>KẾT QUẢ HỌC TẬP
        </h2>
    </div>
</div>

<!-- Form Lọc: Chọn Năm và Học Kỳ -->
@using (Html.BeginForm("XemDiem", "Student", FormMethod.Get, new { @class = "card p-3 mb-4 bg-white border-0 shadow-sm" }))
{
    <div class="row g-3 align-items-end">
        <div class="col-md-5">
            <label class="form-label fw-bold text-secondary">
                <i class="far fa-calendar-alt me-1"></i>Năm học
            </label>
            @Html.DropDownList("maNam", (SelectList)ViewBag.MaNam, new { @class = "form-select", onchange = "this.form.submit()" })
        </div>

        <div class="col-md-5">
            <label class="form-label fw-bold text-secondary">
                <i class="fas fa-filter me-1"></i>Học kỳ
            </label>
            <select name="maHK" class="form-select" onchange="this.form.submit()">
                <option value="HK1" @(ViewBag.SelectedHK == "HK1" ? "selected" : "")>Học kỳ 1</option>
                <option value="HK2" @(ViewBag.SelectedHK == "HK2" ? "selected" : "")>Học kỳ 2</option>
            </select>
        </div>

        <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100 h-100">
                <i class="fas fa-search"></i> Xem
            </button>
        </div>
    </div>
}

@if (Model != null)
{
    <!-- 1. PHẦN TỔNG KẾT -->
    <div class="row mb-4">
        <!-- Card Điểm TB Năm -->
        <div class="col-md-4">
            <div class="card bg-success text-white h-100 shadow-sm">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h6 class="text-uppercase opacity-75">Điểm TB Cả Năm</h6>
                    <h1 class="display-3 fw-bold my-2">
                        @(Model.DIEMTB_CANAM != null ? Model.DIEMTB_CANAM.ToString() : "--")
                    </h1>
                    <div>
                        <span class="badge bg-white text-success fs-6 rounded-pill px-3">
                            @(string.IsNullOrEmpty(Model.XEPLOAI_CANAM) ? "Chưa xếp loại" : Model.XEPLOAI_CANAM)
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Tổng kết HK -->
        <div class="col-md-8">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-bottom fw-bold text-success">
                    <i class="fas fa-history me-1"></i>TỔNG KẾT THEO HỌC KỲ
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0 h-100 align-middle">
                        <tbody>
                            <tr>
                                <th class="ps-4 w-50">Trung bình Học kỳ 1</th>
                                <td class="text-end pe-4 fw-bold fs-5">
                                    @(Model.DIEMTB_HK1 != null ? Model.DIEMTB_HK1.ToString() : "--")
                                    <small class="text-muted fw-normal ms-2">
                                        (@(string.IsNullOrEmpty(Model.XEPLOAI_HK1) ? "Chưa xếp loại" : Model.XEPLOAI_HK1))
                                    </small>
                                </td>
                            </tr>
                            <tr>
                                <th class="ps-4 w-50">Trung bình Học kỳ 2</th>
                                <td class="text-end pe-4 fw-bold fs-5">
                                    @(Model.DIEMTB_HK2 != null ? Model.DIEMTB_HK2.ToString() : "--")
                                    <small class="text-muted fw-normal ms-2">
                                        (@(string.IsNullOrEmpty(Model.XEPLOAI_HK2) ? "Chưa xếp loại" : Model.XEPLOAI_HK2))
                                    </small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. PHẦN BẢNG ĐIỂM CHI TIẾT -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <span class="fw-bold text-uppercase">
                <i class="fas fa-list-ul me-2"></i>Bảng Điểm Chi Tiết - @(ViewBag.SelectedHK == "HK1" ? "Học kỳ 1" : "Học kỳ 2")
            </span>
        </div>
        <div class="card-body p-0 table-responsive">
            <table class="table table-hover table-bordered mb-0 text-center align-middle">
                <thead class="bg-light text-success fw-bold">
                    <tr>
                        <th class="text-start ps-3 py-3">Môn Học</th>
                        <th style="width: 15%">Điểm Miệng</th>
                        <th style="width: 15%">15 Phút</th>
                        <th style="width: 15%">1 Tiết</th>
                        <th style="width: 10%">Thi</th>
                        <th style="width: 10%" class="bg-light text-dark">TB Môn</th>
                    </tr>
                </thead>
                <tbody>
                    @if (listDiemChiTiet != null && listDiemChiTiet.Count() > 0)
                    {
                        foreach (var item in listDiemChiTiet)
                        {
                            <tr>
                                <td class="text-start ps-3 fw-bold text-secondary">@item.TENMH</td>
                                <td class="text-muted">@(item.DiemMieng ?? "-")</td>
                                <td class="text-muted">@(item.Diem15Phut ?? "-")</td>
                                <td class="text-muted">@(item.Diem1Tiet ?? "-")</td>
                                <td class="fw-bold text-primary">@(item.DiemThi ?? "-")</td>
                                <!-- Xử lý hiển thị màu sắc nếu chưa có điểm TB -->
                                <td class="fw-bold @(item.DiemTBMon != null ? "bg-light text-success" : "bg-light text-muted fst-italic") fs-6">
                                    @(item.DiemTBMon != null ? item.DiemTBMon.ToString() : "-")
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="fas fa-folder-open fa-3x mb-3 text-secondary opacity-50"></i>
                                <p>Chưa có dữ liệu điểm chi tiết cho học kỳ này.</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else
{
    <div class="alert alert-warning shadow-sm mt-3" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Chưa có dữ liệu tổng kết cho năm học này.
    </div>
}